name: Self-Test (Test the Tester)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 1 * *'  # Monthly on the 1st day of the month

jobs:
  self-test:
    name: Test ${{ matrix.framework-config.framework }} ${{ matrix.framework-config.version }} (${{ matrix.framework-config.label }}) - PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.1', '8.2', '8.3', '8.4']
        framework-config:
          # Laravel: 11.* (Latest LTS), 12.* (Latest stable)
          - framework: laravel
            version: '11.*'
            install_command: 'laravel/laravel'
            label: 'LTS'
          - framework: laravel
            version: '12.*'
            install_command: 'laravel/laravel'
            label: 'Latest stable'
          # Symfony: 7.4.* (Latest LTS), 8.0.* (Latest stable)
          - framework: symfony
            version: '7.4.*'
            install_command: 'symfony/symfony'
            label: 'LTS'
          - framework: symfony
            version: '8.0.*'
            install_command: 'symfony/symfony'
            label: 'Latest stable'
          # Slim: 4.* (Latest LTS), 5.* (Latest stable/new)
          - framework: slim
            version: '4.*'
            install_command: 'slim/slim-skeleton'
            label: 'LTS'
          - framework: slim
            version: '5.*'
            install_command: 'slim/slim-skeleton'
            label: 'Latest stable'
          # CodeIgniter: 5.* (Latest stable)
          - framework: codeigniter
            version: '5.*'
            install_command: 'codeigniter4/appstarter'
            label: 'Latest stable'
          # CakePHP: 5.* (Latest stable)
          - framework: cakephp
            version: '5.*'
            install_command: 'cakephp/app'
            label: 'Latest stable'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, xml, curl, json, yaml, zip
          coverage: none
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --ignore-platform-reqs
      
      - name: Copy test package
        run: |
          cp -r tests/fixtures/test-package /tmp/test-package
          cd /tmp/test-package
          composer install --no-interaction --prefer-dist --no-scripts
          composer dump-autoload
      
      - name: Create test configuration
        run: |
          cat > /tmp/test-config.yml <<EOF
          package_name: "test/compatibility-package"
          php_versions: ['${{ matrix.php-version }}']
          frameworks:
            ${{ matrix.framework-config.framework }}:
              versions: ['${{ matrix.framework-config.version }}']
              install_command: 'composer create-project ${{ matrix.framework-config.install_command }}'
              php_min_version: '8.1'
          test_scripts:
            - name: autoloading
              script: 'tests/compatibility/check-autoload.php'
              description: 'Test class autoloading'
          EOF
      
      - name: Run compatibility test
        run: |
          php bin/compatibility-tester test \
            --config=/tmp/test-config.yml \
            --framework=${{ matrix.framework-config.framework }} \
            --php=${{ matrix.php-version }} \
            --package-path=/tmp/test-package
        continue-on-error: true
        timeout-minutes: 30
      
      - name: Generate report
        if: always()
        run: |
          php bin/compatibility-tester report \
            --config=/tmp/test-config.yml \
            --package-path=/tmp/test-package \
            --format=json \
            --output=/tmp/report.json || true
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.framework-config.framework }}-${{ matrix.framework-config.version }}-php-${{ matrix.php-version }}
          path: /tmp/report.json
          if-no-files-found: ignore

